from gigachat import GigaChat
import keyring
import requests
from typing import Optional

files_url = "https://gigachat.devices.sberbank.ru/api/v1/files"

def get_access_token() -> str:
    """Retrieve GigaChat access token from keyring"""
    access_token = "N2JmYTgwNDEtMTMzZi00NGExLWFlYTEtMmY1N2NmOTM4MTcxOjRlNzI3YjNhLWE1MGMtNDFmYi04ZjhlLWQ2ZDQ3MTUzMTA3ZQ=="
    if not access_token:
        raise ValueError("GigaChat token not found in keyring. Set it first with: keyring.set_password('myapp', 'gigachat_token', 'your_token')")
    return access_token

def get_headers() -> dict:
    """Generate authorization headers with actual token"""
    access_token = get_access_token()
    return {
        'Accept': 'application/json',
        'Authorization': f'Bearer {access_token}'
    }

def get_file_info(file_id: str) -> dict:
    """Get information about a specific file"""
    try:
        response = requests.get(
            f"{files_url}/{file_id}",
            headers=get_headers(),
            verify=False
        )
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"Error getting file info: {e}")
        return response.text

def delete_file(file_id: str) -> dict:
    """Delete a file by ID"""
    try:
        response = requests.post(
            f"{files_url}/{file_id}/delete",
            headers=get_headers(),
            verify=False
        )
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"Error deleting file: {e}")
        return response.text

def get_files_info() -> dict:
    """Get list of all uploaded files"""
    try:
        response = requests.get(
            files_url,
            headers=get_headers(),
            verify=False
        )
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"Error getting files: {e}")
        return response.text

def get_giga_obj() -> GigaChat:
    """Initialize GigaChat client with credentials"""
    access_token = get_access_token()
    return GigaChat(
        credentials=access_token,
        verify_ssl_certs=False,
        scope="GIGACHAT_API_B2B",
        model="GigaChat-Max",
    )

def upload_file(giga: GigaChat, file_name: str) -> str:
    """Upload a file and return its ID"""
    with open(file_name, "rb") as f:
        file_obj = giga.upload_file(f)
    return file_obj.id_

def chat_with_file(giga: GigaChat, prompt: str, file_id: str) -> str:
    """Send a prompt with an attached file to GigaChat"""
    result = giga.chat(
        {
            "function_call": "auto",
            "messages": [
                {
                    "role": "user",
                    "content": prompt,
                    "attachments": [file_id]  # Should be a list
                }
            ],
            "temperature": 0.1
        }
    )
    return result.choices[0].message.content

giga = get_giga_obj()
print('Init')

with open("doc09531820250805115333.pdf", "rb") as f:
    file = giga.upload_file(f).id_

prompt = """ЗАДАЧА: Анализ письма в конверте от Почты России и извлечение данных в JSON.

Твоя задача — проанализировать изображение, содержащее конверт и вложенные документы, выделить данные и вернуть ответ СТРОГО в формате JSON.

ЭТАП 1: АНАЛИЗ ИСТОЧНИКОВ (ГДЕ ИСКАТЬ ДАННЫЕ)

1. КОНВЕРТ (Приоритет для полей "*Конверта" и "НомерКонверта"):
   - Найди область отправителя на конверте. Извлеки: Наименование отправителя и полный Адрес.
   - Штрих-код Почты России (14 цифр) или трек-номер. Это - "НомерКонверта". Если более 1 штрих-кода на одной из сторон конверта - верни пустую строку.

2. ПИСЬМО/ДОКУМЕНТ (Приоритет для остальных полей):
   - ОтправительДокумента: Определи по шапке/бланку письма (НЕ по конверту).
   - Адрес и Город: Извлеки из реквизитов в шапке письма. "ГородОтправителя" — только название города (без "г.").
   - Получатель: Ищи организацию-получателя. В приоритете ищи: "ТрансТехСервис", "УК ТрансТехСервис", "ТТС".
   - Даты и Номера: Ищи "Исх. №", "Дата". Дата должна быть в формате ГГГГММДД.
   - ИНН/КПП: Ищи в шапке или подвале документа.
   - Содержание: Кратко (1-2 предложения) сформулируй суть требований/просьбы.
   - VIN: Просканируй текст на наличие VIN-номеров (17 знаков, латиница+цифры). Собери их в массив.
   - ИдентификаторВидаДокумента: Перед заполнением поля "ИдентификаторВидаДокумента" важно учесть, какой вид организации отправил документ и какая содержится информация. Используйте следующую схему для выбора значения поля:

        Если ОтправительДокумента является организацией судебной системы (суд, прокуратура, следственный комитет, министерство юстиции, ФАС, Роспотребнадзор, комитеты защиты прав потребителей, департамент защиты прав потребителей и т.п.), выберите значение "Судебные".
        Исключения:  
        Если организация связана с нарушениями ПДД (ГИБДД, ФССП, административная комиссия), проверьте содержание письма. Если письмо касается штрафов за нарушение ПДД, присвоите значение "Штрафы ГИБДД", иначе оставьте "Судебные".
        Если ОтправительДокумента связан с ФССП, СФР, и письмо касается задолженности по зарплате, по алиментам, по кредиту, категория - "Зарплатные".
        Если ОтправительДокумента связан с государственными органами финансовой сферы (налоговая служба, государственная статистика, фонд пенсионного и соцстрахования, минфин), присваивайте значение "Бухгалтерские".
        Если ОтправительДокумента — государственный орган кадровой направленности (военкомат, Минобороны, Минтруд), выбирайте категорию "Кадровые".
        Если ОтправительДокумента — коммунальный ресурсоснабжающая организация (электроэнергия, газ, вода), установите "Коммунальные".
        Если ОтправительДокумента — оператор связи (Мегафон, Билайн, МТС, Таттелеком), используйте значение "Связь".
        Если ОтправительДокумента — страховая компания, выберите "Страховые".
        Если ОтправительДокумента представляет коммерческое предприятие и письмо содержит коммерческое предложение, рекламу или приглашение на событие, выбирайте "Коммерческие".
        Если ОтправительДокумента неизвестен или сообщение носит иной характер, внимательно проанализируйте текст письма:
        Если письмо содержит договоры, приложения, акты выполненных работ, накладные, счета-фактуры, поручения, доверенности и прочие хозяйственно-правовые документы, ставьте "Первичные".
        Если письмо содержит информацию об участи в тендере - определите как "Тендерное".
        Если письмо несёт иную неясную цель, определите его как "Неопределённое".

3. ПРОВЕРКА НА ОШИБКИ:
   - Если внутри конверта документы от разных контрагентов или разным адресатам — верни JSON со статусом "Ошибка".

ЭТАП 2: ФОРМИРОВАНИЕ ОТВЕТА

Верни ответ ТОЛЬКО в формате JSON. Не добавляй пояснений.
Если данных нет — оставляй пустую строку "" (для VIN — пустой массив []).

СТРУКТУРА JSON:
{
  "Статус": "Успешно",
  "ДатаДокумента": "ГГГГММДД",
  "НомерДокумента": "строка",
  "ВидДокумента": "вид документа (без привязки к перечню, своими словами)",
  "ИдентификаторВидаДокумента": "ИдентификаторВидаДокумента",
  "ОтправительДокумента": "строка (по бланку)",
  "ОтправительКонверта": "строка (с конверта)",
  "АдресОтправителя": "строка (из документа)",
  "АдресОтправителяКонверта": "строка (с конверта)",
  "ИННОтправителя": "строка",
  "ГородОтправителя": "название города (например: Казань)",
  "ОрганизацияПолучатель": "строка (приоритет ТТС)",
  "ИННПолучателя": "строка",
  "КПППолучателя": "строка",
  "VIN": ["VIN1", "VIN2"],
  "Содержание": "краткое изложение требований",
  "НомерКонверта": "штрихкод конверта"
}

Если обнаружена критическая ошибка (разные адресаты/отправители), верни:
{
  "Статус": "Ошибка",
  "Причина": "описание причины"
}

"""

prompt1 = """ЗАДАЧА - оценка профессионализма продажника на основе разговора с клиентом.
    Выведи структурированный отчёт по оценке качеств. Создай личные рекомендации для повышения качества общения с клиентом.
    JSON-файл с критериями:
    {
            "Установление контакта": {
                "weight": 0.10,
                "subcriteria": [
                    "Приветствие по имени/отчеству клиента",
                    "Представление себя и дилерского центра",
                    "Установление комфортной атмосферы",
                    "Выявление цели визита/звонка"
                ]
            },
            "Выявление потребностей": {
                "weight": 0.20,
                "subcriteria": [
                    "Активное слушание",
                    "Задавание открытых вопросов",
                    "Выяснение бюджета клиента",
                    "Определение сроков покупки",
                    "Узнавание предыдущего опыта владения авто"
                ]
            },
            "Презентация автомобиля": {
                "weight": 0.25,
                "subcriteria": [
                    "Акцент на преимуществах, а не только характеристиках",
                    "Использование техники FAB (Feature-Advantage-Benefit)",
                    "Демонстрация в соответствии с потребностями клиента",
                    "Тест-драйв или активная демонстрация",
                    "Ответы на технические вопросы"
                ]
            },
            "Работа с возражениями": {
                "weight": 0.20,
                "subcriteria": [
                    "Спокойная реакция на возражения",
                    "Выяснение причин возражений",
                    "Приведение аргументированных контраргументов",
                    "Предложение альтернатив при необходимости"
                ]
            },
            "Завершение сделки": {
                "weight": 0.15,
                "subcriteria": [
                    "Определение готовности к покупке",
                    "Обсуждение условий финансирования/обмена",
                    "Предложение дополнительного оборудования",
                    "Четкое описание дальнейших шагов"
                ]
            },
            "Профессионализм": {
                "weight": 0.10,
                "subcriteria": [
                    "Знание продукта",
                    "Культура речи и грамотность",
                    "Пунктуальность и соблюдение сроков",
                    "Внешний вид (для личной встречи)"
                ]
            }
        }

"""

prompt2 = """ЗАДАЧА - оценка профессиональных навыков и умений, приведших к успешной продаже автомобиля.
Контекст: разговор продажника с клиентом, который привёл к успешной продаже автомобиля.
На основе предоставленной аудиозаписи, выяви действующие стороны диалога (Продавец-покупатель).
Определи, какие профессиональные навыки и умения привели к успешной продаже автомобиля продавцом на основе анализа психосоматики покупателя.
Выведи 10 навыков и умений в формате json, каждый критерий - отдельная категория с своими подкритериями, Weihgt (Вес, влияние на результат) в процентах.
Ответ: только итоговый json.
"""
print("Saved file")
result = giga.chat(
    {
        "function_call": "auto",
        "messages": [
            {
                "role": "user",
                "content": prompt,
                "attachments": [file]
            }
        ],
        "temperature": 0.1
    },
)
# В новых версиях SDK может быть напрямую доступно
if hasattr(result, 'usage'):
    print(f"Потрачено токенов: {result.usage}")
elif hasattr(result, 'choices') and result.choices:
    # Ищем в первом сообщении
    message = result.choices[0].message
    if hasattr(message, 'usage'):
        print(f"Потрачено токенов: {message.usage.prompt_tokens}, {message.usage.completion_tokens}")
# Альтернативно: просто выведем ответ как есть
response_text = result.choices[0].message.content

# Разделим на секции по заголовкам
import re

# Ищем все заголовки
sections = re.split(r'\n(?=[А-Я][А-Я\s]+:)', response_text)

for section in sections:
    if section.strip():
        lines = section.strip().split('\n')
        if lines:
            # Выделяем заголовок
            header = lines[0]
            print(f"{header}")
            # Выводим содержимое
            for line in lines[1:]:
                if line.strip():
                    print(f"  {line.strip()}")