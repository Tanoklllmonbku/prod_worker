import asyncio
import logging
import unittest

from core.factories import _create_llm_connector
from config.config import get_settings
from concurrent.futures.thread import ThreadPoolExecutor


token = "N2JmYTgwNDEtMTMzZi00NGExLWFlYTEtMmY1N2NmOTM4MTcxOjRlNzI3YjNhLWE1MGMtNDFmYi04ZjhlLWQ2ZDQ3MTUzMTA3ZQ=="
prompt = """ЗАДАЧА: Анализ письма в конверте от Почты России и извлечение данных в JSON.

Твоя задача — проанализировать файл, содержащий конверт и вложенные документы, выделить данные и вернуть ответ СТРОГО в формате JSON.

ЭТАП 1: АНАЛИЗ ИСТОЧНИКОВ (ГДЕ ИСКАТЬ ДАННЫЕ)

1. КОНВЕРТ (Приоритет для полей "*Конверта" и "НомерКонверта"):
   - Найди область отправителя на конверте. Извлеки: Наименование отправителя и полный Адрес.
   - Штрих-код Почты России (14 цифр) или трек-номер. Это - "НомерКонверта". Если более 1 штрих-кода на одной из сторон конверта - верни пустую строку.

2. ПИСЬМО/ДОКУМЕНТ (Приоритет для остальных полей):
   - ОтправительДокумента: Определи по шапке/бланку письма (НЕ по конверту).
   - Адрес и Город: Извлеки из реквизитов в шапке письма. "ГородОтправителя" — только название города (без "г.").
   - Получатель: Ищи организацию-получателя. В приоритете ищи: "ТрансТехСервис", "УК ТрансТехСервис", "ТТС".
   - Даты и Номера: Ищи "Исх. №", "Дата". Дата должна быть в формате ГГГГММДД.
   - ИНН/КПП: Ищи в шапке или подвале документа.
   - Содержание: Кратко (1-2 предложения) сформулируй суть требований/просьбы.
   - VIN: Просканируй текст на наличие VIN-номеров (17 знаков, латиница+цифры). Собери их в массив.
   - ИдентификаторВидаДокумента: Перед заполнением поля "ИдентификаторВидаДокумента" важно учесть, какой вид организации отправил документ и какая содержится информация. Используйте следующую схему для выбора значения поля:

        Если ОтправительДокумента является организацией судебной системы (суд, прокуратура, следственный комитет, министерство юстиции, ФАС, Роспотребнадзор, комитеты защиты прав потребителей, департамент защиты прав потребителей и т.п.), выберите значение "Судебные".
        Исключения:  
        Если организация связана с нарушениями ПДД (ГИБДД, ФССП, административная комиссия), проверьте содержание письма. Если письмо касается штрафов за нарушение ПДД, присвоите значение "Штрафы ГИБДД", иначе оставьте "Судебные".
        Если ОтправительДокумента связан с ФССП, СФР, и письмо касается задолженности по зарплате, по алиментам, по кредиту, категория - "Зарплатные".
        Если ОтправительДокумента связан с государственными органами финансовой сферы (налоговая служба, государственная статистика, фонд пенсионного и соцстрахования, минфин), присваивайте значение "Бухгалтерские".
        Если ОтправительДокумента — государственный орган кадровой направленности (военкомат, Минобороны, Минтруд), выбирайте категорию "Кадровые".
        Если ОтправительДокумента — коммунальный ресурсоснабжающая организация (электроэнергия, газ, вода), установите "Коммунальные".
        Если ОтправительДокумента — оператор связи (Мегафон, Билайн, МТС, Таттелеком), используйте значение "Связь".
        Если ОтправительДокумента — страховая компания, выберите "Страховые".
        Если ОтправительДокумента представляет коммерческое предприятие и письмо содержит коммерческое предложение, рекламу или приглашение на событие, выбирайте "Коммерческие".
        Если ОтправительДокумента неизвестен или сообщение носит иной характер, внимательно проанализируйте текст письма:
        Если письмо содержит договоры, приложения, акты выполненных работ, накладные, счета-фактуры, поручения, доверенности и прочие хозяйственно-правовые документы, ставьте "Первичные".
        Если письмо содержит информацию об участи в тендере - определите как "Тендерное".
        Если письмо несёт иную неясную цель, определите его как "Неопределённое".

3. ПРОВЕРКА НА ОШИБКИ:
   - Если внутри конверта документы от разных контрагентов или разным адресатам — верни JSON со статусом "Ошибка".

ЭТАП 2: ФОРМИРОВАНИЕ ОТВЕТА

Верни ответ ТОЛЬКО в формате JSON. Не добавляй пояснений.
Если данных нет — оставляй пустую строку "" (для VIN — пустой массив []).

СТРУКТУРА JSON:
{
  "Статус": "Успешно",
  "ДатаДокумента": "ГГГГММДД",
  "НомерДокумента": "строка",
  "ВидДокумента": "вид документа (без привязки к перечню, своими словами)",
  "ИдентификаторВидаДокумента": "ИдентификаторВидаДокумента",
  "ОтправительДокумента": "строка (по бланку)",
  "ОтправительКонверта": "строка (с конверта)",
  "АдресОтправителя": "строка (из документа)",
  "АдресОтправителяКонверта": "строка (с конверта)",
  "ИННОтправителя": "строка",
  "ГородОтправителя": "название города (например: Казань)",
  "ОрганизацияПолучатель": "строка (приоритет ТТС)",
  "ИННПолучателя": "строка",
  "КПППолучателя": "строка",
  "VIN": ["VIN1", "VIN2"],
  "Содержание": "краткое изложение требований",
  "НомерКонверта": "штрихкод конверта"
}

Если обнаружена критическая ошибка (разные адресаты/отправители), верни:
{
  "Статус": "Ошибка",
  "Причина": "описание причины"
}

"""
class TestGigaConnector(unittest.IsolatedAsyncioTestCase):
    @classmethod
    def setUpClass(cls):
        """
        Выполняется один раз перед всеми тестами в классе.
        Подготавливает настройки и создаёт коннектор.
        """
        # Убедимся, что используем переменные окружения
        cls.config = get_settings()

        # Создаём коннектор через фабрику
        cls.connector = _create_llm_connector(cls.config)
    async def test_workflow(self):
        """Example showing concurrent file uploads and chat requests"""
        # get_logger = logging.getLogger,
        # model = "GigaChat-Max",
        # scope = "GIGACHAT_API_B2B",
        # verify_ssl = False,
        # timeout = 30.0,
        # base_url = "https://gigachat.devices.sberbank.ru",
        # api_version = "api/v1",
        # oauth_url = "https://ngw.devices.sberbank.ru:9443/api/v2/oauth"
        try:
            # Initialize connection
            await self.connector.initialize()
            with open("doc09531820250805115333.pdf", "rb") as f:
                file_ids = await self.connector.upload_file(f)
            print(f"Uploaded files: {file_ids}")

            # Example 2: Chat with files
            response = await self.connector.chat(
                prompt=prompt,
                file_ids=[file_ids],
                temperature=0.1,
            )
            print(f"Chat response: {response['response']}")
            print(f"Tokens used: {response['tokens_used']}")

            # Example 5: Health check
            is_healthy = await self.connector.health_check()
            print(f"\nAPI Health: {is_healthy}")

            # Example 6: List and delete files
            all_files = await self.connector.list_files()
            print(f"\nTotal files in storage: {len(all_files)}")

            if file_ids:
                delete_results = await self.connector.delete_files_concurrent([file_ids])
                print(f"Deletion results: {delete_results}")

        finally:
            await self.connector.shutdown()


