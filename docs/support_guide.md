# Руководство по поддержке LLM Service

## Содержание
1. [Обзор поддержки](#обзор-поддержки)
2. [Мониторинг производительности](#мониторинг-производительности)
3. [Алерты и уведомления](#алерты-и-уведомления)
4. [План действий при инцидентах](#план-действий-при-инцидентах)
5. [Регулярные задачи обслуживания](#регулярные-задачи-обслуживания)
6. [Анализ логов](#анализ-логов)
7. [Резервное копирование и восстановление](#резервное-копирование-и-восстановление)

## Обзор поддержки

LLM Service требует регулярного мониторинга для обеспечения стабильной работы. Поддержка включает:
- Мониторинг производительности
- Анализ логов
- Управление инцидентами
- Регулярное обслуживание

## Мониторинг производительности

### Ключевые метрики

#### 1. Производительность обработки
- **Среднее время обработки задачи**: норма < 60 секунд
- **Количество задач в обработке**: не должно превышать WORKER_MAX_CONCURRENT_TASKS
- **Количество задач в очереди Kafka**: контролировать задержку

#### 2. Состояние подключений
- **Соединение с Kafka**: активное/неактивное
- **Соединение с MinIO**: активное/неактивное
- **Соединение с GigaChat API**: активное/неактивное

#### 3. Использование ресурсов
- **Использование CPU**: < 80%
- **Использование RAM**: < 80%
- **Доступное место на диске**: > 1GB

### Мониторинг через логи

#### Уровень INFO
```
[timestamp] - INFO - Worker started, listening to Kafka topic 'tasks_llm'...
[timestamp] - INFO - Processing task {task_id} with worker {worker_id}
[timestamp] - INFO - Task {task_id} completed: {tokens_used} tokens
```

#### Уровень WARNING
```
[timestamp] - WARNING - Circuit breaker OPEN after {failure_count} failures
[timestamp] - WARNING - Failed to process task {task_id}: {error}
```

#### Уровень ERROR
```
[timestamp] - ERROR - Failed to initialize interface: {error}
[timestamp] - ERROR - Bootstrap failed: {error}
```

### Команды для мониторинга

#### Проверка статуса контейнера
```bash
docker ps | grep llm-service
docker stats llm-service
```

#### Проверка логов
```bash
# Последние 50 строк логов
docker logs llm-service --tail 50

# Логи с фильтрацией по ошибкам
docker logs llm-service 2>&1 | grep -i error

# Логи с фильтрацией по предупреждениям
docker logs llm-service 2>&1 | grep -i warning
```

#### Проверка Kafka
```bash
# Статус потребителей
kafka-consumer-groups --bootstrap-server localhost:9092 --describe --group llm-worker-group

# Задержка потребления
kafka-consumer-groups --bootstrap-server localhost:9092 --describe --group llm-worker-group --verbose
```

## Алерты и уведомления

### Критические алерты (требуют немедленного внимания)

#### 1. Сервис не запущен
**Триггер**: контейнер не запущен более 5 минут
**Действие**: перезапустить сервис

#### 2. Bootstrap неудачный
**Триггер**: 5 неудачных попыток bootstrap подряд
**Действие**: проверить конфигурацию и внешние зависимости

#### 3. Ошибки подключения к Kafka
**Триггер**: 10 ошибок подключения в минуту
**Действие**: проверить доступность Kafka

#### 4. Ошибки подключения к GigaChat
**Триггер**: Circuit breaker OPEN
**Действие**: проверить токен и доступность API

### Предупреждения (требуют внимания в течение 4 часов)

#### 1. Высокая задержка обработки
**Триггер**: среднее время обработки > 2 минут
**Действие**: проверить нагрузку и ресурсы

#### 2. Накопление задач в Kafka
**Триггер**: задержка потребления > 10 минут
**Действие**: проверить производительность обработки

#### 3. Высокое использование ресурсов
**Триггер**: CPU или RAM > 90%
**Действие**: масштабировать или оптимизировать

## План действий при инцидентах

### Инцидент 1: Сервис не запущен

**Симптомы**:
- Контейнер не запущен
- Нет обработки задач

**Действия**:
1. Проверить статус контейнера: `docker ps | grep llm-service`
2. Проверить логи: `docker logs llm-service`
3. Попробовать перезапустить: `docker start llm-service`
4. Если не помогает, пересоздать контейнер

### Инцидент 2: Ошибки обработки задач

**Симптомы**:
- Много статусов FAILED (4)
- Высокий процент ошибок

**Действия**:
1. Проверить логи на ошибки: `docker logs llm-service | grep -i error`
2. Проверить доступность MinIO: `curl -I http://minio:9000/minio/health/live`
3. Проверить токен GigaChat
4. Проверить размеры файлов (слишком большие файлы могут вызывать таймауты)

### Инцидент 3: Высокая задержка обработки

**Симптомы**:
- Задачи обрабатываются слишком долго
- Накопление задач в Kafka

**Действия**:
1. Проверить количество активных воркеров
2. Увеличить WORKER_MAX_CONCURRENT_TASKS (если ресурсов достаточно)
3. Проверить производительность внешних сервисов
4. Проверить размеры обрабатываемых файлов

### Инцидент 4: Ошибки подключения к Kafka

**Симптомы**:
- Нет получения новых задач
- Ошибки подключения к Kafka

**Действия**:
1. Проверить доступность Kafka: `docker exec kafka_container kafka-topics --list`
2. Проверить настройки подключения в .env
3. Проверить топик `tasks_llm`: `kafka-topics --describe --topic tasks_llm`
4. Проверить права доступа к топику

## Регулярные задачи обслуживания

### Ежедневно
- [ ] Проверка логов на наличие ошибок
- [ ] Проверка статуса контейнера
- [ ] Проверка задержки в Kafka
- [ ] Проверка использования ресурсов

### Еженедельно
- [ ] Анализ производительности за неделю
- [ ] Проверка размера логов
- [ ] Проверка целостности данных
- [ ] Обновление статистики по обработке задач

### Ежемесячно
- [ ] Ротация логов
- [ ] Проверка резервных копий
- [ ] Обновление образа (если доступно)
- [ ] Аудит безопасности

### Ежеквартально
- [ ] Полная проверка производительности
- [ ] Обновление документации
- [ ] Проверка плана восстановления
- [ ] Обновление зависимостей

## Анализ логов

### Структура логов
```
{version} - {logger} - {function} - {timestamp} - {service} - {level} - {message}
```

### Примеры анализа

#### Анализ частоты ошибок
```bash
# Подсчет ошибок за последний час
docker logs llm-service --since 1h | grep -i error | wc -l

# Топ 10 частых ошибок
docker logs llm-service | grep -i error | sort | uniq -c | sort -nr | head -10
```

#### Анализ производительности
```bash
# Среднее время обработки задач
docker logs llm-service | grep "Task.*processed in" | grep -o "[0-9.]*ms" | awk '{sum+=$1; count++} END {print "Average:", sum/count, "ms"}'
```

#### Анализ статусов задач
```bash
# Количество задач по статусам
docker logs llm-service | grep "Status.*sent for task" | awk '{print $4}' | sort | uniq -c
```

## Резервное копирование и восстановление

### Что резервировать
- Файл конфигурации `.env`
- Логи сервиса (архивировать ежедневно)
- Базу данных PostgreSQL (если используется для логирования)

### План резервного копирования
```bash
# Ежедневное резервное копирование логов
docker logs llm-service > /backup/logs/llm-service-$(date +%Y%m%d).log

# Резервное копирование конфигурации
cp .env /backup/config/llm-service-$(date +%Y%m%d).env

# Резервное копирование базы данных (если используется)
pg_dump -h localhost -U postgres llm_worker > /backup/db/llm_worker-$(date +%Y%m%d).sql
```

### План восстановления
1. Восстановить конфигурацию из резервной копии
2. Запустить внешние зависимости (Kafka, MinIO, PostgreSQL)
3. Запустить LLM Service
4. Проверить обработку задач
5. Проверить логи на наличие ошибок

### Проверка резервных копий
- Ежемесячно проверять целостность резервных копий
- Проверять возможность восстановления из резервной копии
- Обновлять резервные копии при изменениях конфигурации